<Project>

  <!--
    Partial fix for Coverlet when EnableSourceLink = true.
    Issues: fails when UseSourceLink = true, all paths are still local.
    References.
    - https://github.com/clairernovotny/DeterministicBuilds
    - https://github.com/coverlet-coverage/coverlet/blob/master/Documentation/DeterministicBuild.md
    -->
  <Target Name="CoverletGetPathMap"
          DependsOnTargets="InitializeSourceRootMappedPaths"
          Returns="@(_LocalTopLevelSourceRoot)"
          Condition=" '$(DeterministicSourcePaths)' == 'true' ">
    <ItemGroup>
      <_LocalTopLevelSourceRoot Include="@(SourceRoot)" Condition=" '%(SourceRoot.NestedRoot)' == '' "/>
    </ItemGroup>
  </Target>

  <!--
    Command-line options:
    - MyAssemblyTitle   default = AssemblyName
  -->
  <PropertyGroup>
    <MyAssemblyTitle Condition=" '$(MyAssemblyTitle)' == '' ">$(AssemblyName)</MyAssemblyTitle>

    <AssemblyTitle>$(MyAssemblyTitle) [$(TargetFramework)]</AssemblyTitle>
  </PropertyGroup>

  <!-- API profiles -->
  <PropertyGroup>
    <!-- See "Supported Platforms" in D.B.props -->
    <ApiProfileMoniker>netstandard2.0</ApiProfileMoniker>
    <ApiProfileMoniker Condition=" '$(TargetFramework)' == 'netstandard2.1' ">netstandard2.1</ApiProfileMoniker>
    <ApiProfileMoniker Condition=" $(TargetFramework.StartsWith('netcoreapp3.')) ">netstandard2.1</ApiProfileMoniker>
  </PropertyGroup>

  <!-- Compiler symbols -->
  <PropertyGroup>
    <!-- CONTRACTS_FULL is necessary to enable the attribute Pure -->
    <DefineConstants>$(DefineConstants);CONTRACTS_FULL</DefineConstants>

    <!-- Ranges of platforms.
         In this project, NETSTANDARD1_x really means NETSTANDARD1_1, that is,
         even if something works w/ say "netstandar1.6", we will treat the case
         as if it was "netstandard1.1".
    -->
    <DefineConstants Condition=" $(TargetFramework.StartsWith('netstandard1.')) ">$(DefineConstants);NETSTANDARD1_x</DefineConstants>
    <DefineConstants Condition=" $(TargetFramework.StartsWith('netcoreapp2.')) ">$(DefineConstants);NETCOREAPP2_x</DefineConstants>

    <!-- API profiles -->
    <DefineConstants Condition=" '$(ApiProfileMoniker)' == 'netstandard2.1' ">$(DefineConstants);API_PROFILE_21</DefineConstants>
  </PropertyGroup>

  <!-- Shims for older platforms -->
  <ItemGroup>
    <Compile Include="$(SourceRoot)MissingAttributes.cs" />
    <Compile Include="$(SourceRoot)NullableAttributes.cs" />
  </ItemGroup>

  <!-- .NET Framework reference libraries -->
  <ItemGroup Condition=" '$(TargetFrameworkIdentifier)' == '.NETFramework' ">
    <PackageReference Include="Microsoft.NETFramework.ReferenceAssemblies" Version="1.0.0">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers</IncludeAssets>
    </PackageReference>
  </ItemGroup>

</Project>

<Project>

  <Import Project="$(MSBuildThisFileDirectory)..\Directory.Build.targets" />

  <!--
    Command-line options (default = disabled, to enable /p:XXX=true):
    - Retail                Meta-option
    - HideInternals         Abc.Maybe internals are hidden from Abc.Testing
                            NB: if Retail = true, HideInternals has no effect
    - NoWarnX               More NoWarn's
    - PatchEquality
    - PrintSettings         Enable target PrintSettings?

    Project configuration:
    - NoWarnCS1591          default = true
    - RelaxWarnings         default = false
    - RelaxAsyncWarnings    default = false
  -->

  <Import Project="$(MSBuildThisFileDirectory)Retail.props"
          Condition=" $(Retail) == 'true' and $(IsPackable) == 'true' " />

  <PropertyGroup>
    <VisibleInternals>true</VisibleInternals>
    <VisibleInternals Condition=" $(HideInternals) == 'true' ">false</VisibleInternals>

    <NoWarnCS1591 Condition=" $(NoWarnCS1591) == '' ">true</NoWarnCS1591>
  </PropertyGroup>

  <PropertyGroup Condition=" $(Retail) == 'true' ">
    <SignAssembly>true</SignAssembly>
    <CheckForOverflowUnderflow>false</CheckForOverflowUnderflow>
    <GenerateDocumentationFile>true</GenerateDocumentationFile>
    <VisibleInternals>false</VisibleInternals>

    <DefineConstants>$(DefineConstants);UNCHECKED</DefineConstants>
  </PropertyGroup>

  <PropertyGroup Condition=" $(VisibleInternals) == 'true' ">
    <DefineConstants>$(DefineConstants);INTERNALS_VISIBLE_TO</DefineConstants>
    <!-- Abc.Testing uses the missing and the nullable attributes from Abc.Maybe -->
    <DefineConstants Condition=" $(AssemblyName) == 'Abc.Testing' ">$(DefineConstants);USE_ATTRS_FROM_ABC_MAYBE</DefineConstants>
  </PropertyGroup>

  <PropertyGroup>
    <DefineConstants Condition=" $(SignAssembly) == 'true' ">$(DefineConstants);SIGNED_ASSEMBLY</DefineConstants>
    <DefineConstants Condition=" $(PatchEquality) == 'true' ">$(DefineConstants);PATCH_EQUALITY</DefineConstants>

    <!--<DefineConstants>$(DefineConstants);PLAIN_LINQ</DefineConstants>-->
    <!--<DefineConstants>$(DefineConstants);PURE_MAYBE</DefineConstants>-->
  </PropertyGroup>

  <PropertyGroup>
    <!--
      CA1034  Nested types should not be visible
      CA1303  Do not pass literals as localized parameters
      CA1707  Identifiers should not contain underscores
      CA2007  Consider calling ConfigureAwait on the awaited task
      CS1591  Missing XML comment for publicly visible type or member 'Type_or_Member'
    -->
    <NoWarn Condition=" $(RelaxWarnings) == 'true' ">$(NoWarn);CA1034;CA1303;CA1707</NoWarn>
    <NoWarn Condition=" $(RelaxAsyncWarnings) == 'true' ">$(NoWarn);CA2007</NoWarn>
    <NoWarn Condition=" $(NoWarnCS1591) == 'true' ">$(NoWarn);CS1591</NoWarn>

    <!-- Maybe append a custom list of excluded rules (for PS scripts) -->
    <NoWarn Condition=" $(NoWarnX) != '' ">$(NoWarn);$(NoWarnX)</NoWarn>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.CodeAnalysis.FxCopAnalyzers" Version="3.0.0">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
  </ItemGroup>

  <Target Name="PrintSettings" BeforeTargets="Compile"
          Condition=" $(PrintSettings) == 'true' and $(TargetFramework) != '' ">
    <PropertyGroup>
      <_MyMessage Condition=" $(VisibleInternals) == 'true' ">| will NOT hide its internals.</_MyMessage>
      <_MyMessage Condition=" $(VisibleInternals) != 'true' ">| will hide its internals.</_MyMessage>

      <_MyMessage Condition=" $(CheckForOverflowUnderflow) == 'true' ">$(_MyMessage)%0A| will use checked arithmetic.</_MyMessage>
      <_MyMessage Condition=" $(CheckForOverflowUnderflow) != 'true' ">$(_MyMessage)%0A| will NOT use checked arithmetic.</_MyMessage>

      <_MyMessage Condition=" $(PatchEquality) == 'true' ">$(_MyMessage)%0A| will patch the equality rules.</_MyMessage>

      <_MyMessage>$(_MyMessage)%0A| %24(ApiProfileMoniker) = "$(ApiProfileMoniker)"</_MyMessage>
      <_MyMessage>$(_MyMessage)%0A| %24(EnableSourceLink) = "$(EnableSourceLink)"</_MyMessage>
      <_MyMessage>$(_MyMessage)%0A| %24(DebugType) = "$(DebugType)"</_MyMessage>
      <_MyMessage>$(_MyMessage)%0A| %24(NoWarn) = "$(NoWarn)"</_MyMessage>
      <_MyMessage>$(_MyMessage)%0A| %24(DefineConstants) = "$(DefineConstants)"</_MyMessage>
    </PropertyGroup>

    <Message Text="+ $(AssemblyName) for $(TargetFramework)%0A$(_MyMessage)" Importance="high" />
  </Target>

</Project>

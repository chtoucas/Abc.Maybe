<Project>

  <Import Project="$(MSBuildThisFileDirectory)Retail.tasks" />
  <Import Project="$(MSBuildThisFileDirectory)Retail.props" />

  <PropertyGroup>
    <!-- Deterministic build? Disabled as it seems to conflict with the fact
       that we change the assembly file version on every build.
       https://blog.paranoidcoding.com/2016/04/05/deterministic-builds-in-roslyn.html
      -->
    <!--<Deterministic>true</Deterministic>-->

    <!-- Include the symbols -->
    <AllowedOutputExtensionsInPackageBuildOutputFolder>$(AllowedOutputExtensionsInPackageBuildOutputFolder);.pdb</AllowedOutputExtensionsInPackageBuildOutputFolder>

    <!-- Package Version.
      https://docs.microsoft.com/en-gb/dotnet/standard/library-guidance/versioning
    -->
    <!-- Discard warning NU5105 (SemVer 1.0) -->
    <NoWarn>$(NoWarn);NU5105</NoWarn>
    <VersionPrefix>$(MajorVersion).$(MinorVersion).$(PatchVersion)</VersionPrefix>
    <VersionSuffix>$(PreReleaseLabel.Replace('.', '-'))</VersionSuffix>

    <!-- Strong name the assembly.
      https://docs.microsoft.com/en-gb/dotnet/standard/library-guidance/strong-naming
      https://github.com/dotnet/runtime/blob/master/docs/project/strong-name-signing.md
    -->
    <SignAssembly>true</SignAssembly>
    <DefineConstants>$(DefineConstants);SIGNED_ASSEMBLY</DefineConstants>
    <AssemblyOriginatorKeyFile>$(MSBuildThisFileDirectory)Maybe.snk</AssemblyOriginatorKeyFile>
    <DelaySign>false</DelaySign>
  </PropertyGroup>

  <!-- This target must run very early (before Build is not enough) -->
  <Target Name="SetAssemblyInfo" BeforeTargets="GetAssemblyAttributes">
    <Message Text="Creating the assembly version file..." Importance="normal" />

    <GenerateBuildAndRevisionNumbers>
      <Output TaskParameter="BuildNumber" PropertyName="_BuildNumber"/>
      <Output TaskParameter="RevisionNumber" PropertyName="_RevisionNumber"/>
    </GenerateBuildAndRevisionNumbers>

    <PropertyGroup>
      <_SemVer>$(MajorVersion).$(MinorVersion).$(PatchVersion)</_SemVer>
      <_SemVer Condition=" '$(PreReleaseLabel)' != '' ">$(_SemVer)-$(PreReleaseLabel)</_SemVer>

      <_Metadata>$(Configuration)+$(Platform)</_Metadata>
      <_Metadata Condition=" '$(Platform)|$(Prefer32Bit)' == 'AnyCPU|true' ">$(_Metadata)+32BitPref</_Metadata>
      <!-- The assemlby is always signed here but we never know -->
      <_Metadata Condition=" '$(SignAssembly)' == 'true' ">$(_Metadata)+Signed</_Metadata>
      <_Metadata Condition=" '$(SignAssembly)' != 'true' ">$(_Metadata)+Unsigned</_Metadata>

      <!-- If available use the git commit hash; otherwise use the metadata -->
      <_BuildMetadata Condition=" '$(GitCommitHash)' != '' ">$(GitCommitHash.Substring(0, 7))</_BuildMetadata>
      <_BuildMetadata Condition=" '$(GitCommitHash)' == '' ">$(_Metadata.Replace('+', '.').ToLowerInvariant())</_BuildMetadata>

      <_SemVer>$(_SemVer)+$(_BuildMetadata)</_SemVer>
    </PropertyGroup>

    <PropertyGroup>
      <!-- Remarks: Oddly the default behaviour is to use the assembly name
        (Abc.Maybe) for AssemblyTitle. I want to include build infos. I would
        have use Description for that but it does not show up in the Windows
        properties dialog. -->
      <AssemblyTitle>$(Title) $(_Metadata) built on $([System.DateTime]::UtcNow.ToString()).</AssemblyTitle>
      <!-- To reduce binding redirects we only include the major & minor parts -->
      <AssemblyVersion>$(MajorVersion).$(MinorVersion).0.0</AssemblyVersion>
      <FileVersion>$(MajorVersion).$(MinorVersion).$(_BuildNumber).$(_RevisionNumber)</FileVersion>
      <InformationalVersion>$(_SemVer)</InformationalVersion>
    </PropertyGroup>
  </Target>

</Project>
<Project InitialTargets="__CheckRetailTargets">

  <Import Project="$(MSBuildThisFileDirectory)Retail.tasks" />

  <PropertyGroup>
    <!-- Sign the assembly, add debug symbols, hide internals -->
    <SignAssembly>true</SignAssembly>
    <AllowedOutputExtensionsInPackageBuildOutputFolder Condition=" $(DebugType) != 'embedded' ">$(AllowedOutputExtensionsInPackageBuildOutputFolder);.pdb</AllowedOutputExtensionsInPackageBuildOutputFolder>
    <DefineConstants>$(DefineConstants);NO_INTERNALS_VISIBLE_TO</DefineConstants>

    <!--
      Versioning.
        AssemblyVersion      = Major.Minor.0.0
        PackageVersion       = Major.Minor.Patch-PreReleaseTag
        InformationalVersion = Major.Minor.Patch-PreReleaseTag+BuildMetadata
        FileVersion          = Major.Minor.BuildNumber.RevisionNumber
      -->
    <BuildMetadata Condition=" '$(RepositoryCommit)' != '' ">$(RepositoryCommit.Substring(0, 7))</BuildMetadata>
    <!-- Semantic version -->
    <SemanticVersion>$(MajorVersion).$(MinorVersion).$(PatchVersion)</SemanticVersion>
    <SemanticVersion Condition=" '$(PreReleaseTag)' != '' ">$(SemanticVersion)-$(PreReleaseTag)</SemanticVersion>
    <SemanticVersion Condition=" '$(BuildMetadata)' != '' ">$(SemanticVersion)+$(BuildMetadata)</SemanticVersion>
    <!-- Package version -->
    <VersionPrefix>$(MajorVersion).$(MinorVersion).$(PatchVersion)</VersionPrefix>
    <VersionSuffix>$(PreReleaseTag)</VersionSuffix>
    <!-- Assembly version -->
    <AssemblyVersion>$(MajorVersion).$(MinorVersion).0.0</AssemblyVersion>
    <InformationalVersion>$(SemanticVersion)</InformationalVersion>

    <!-- Oddly, the default AssemblyTitle uses AssemblyName not Title -->
    <AssemblyTitle>$(Title)</AssemblyTitle>
    <Description>$(Title) Built [$([System.DateTime]::UtcNow.ToString("r"))].</Description>
  </PropertyGroup>

  <!-- This target must run very early (before Build is not enough) -->
  <Target Name="SetAssemblyFileVersion" BeforeTargets="GetAssemblyAttributes">
    <Message Text="Setting assembly file version." Importance="normal" />

    <GenerateBuildAndRevisionNumbers>
      <Output TaskParameter="BuildNumber" PropertyName="_BuildNumber"/>
      <Output TaskParameter="RevisionNumber" PropertyName="_RevisionNumber"/>
    </GenerateBuildAndRevisionNumbers>

    <PropertyGroup>
      <FileVersion>$(MajorVersion).$(MinorVersion).$(_BuildNumber).$(_RevisionNumber)</FileVersion>
    </PropertyGroup>
  </Target>

  <Target Name="__CheckRetailTargets">
    <Error Text="Property MajorVersion is empty." Condition=" $(MajorVersion) == '' " />
    <Error Text="Property MinorVersion is empty." Condition=" $(MinorVersion) == '' " />
    <Error Text="Property PatchVersion is empty." Condition=" $(PatchVersion) == '' " />
  </Target>

</Project>
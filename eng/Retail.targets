<Project>

  <Import Project="$(MSBuildThisFileDirectory)Retail.tasks" />
  <Import Project="$(MSBuildThisFileDirectory)Retail.props" />

  <PropertyGroup>
    <Deterministic>true</Deterministic>

    <AllowedOutputExtensionsInPackageBuildOutputFolder>$(AllowedOutputExtensionsInPackageBuildOutputFolder);.pdb</AllowedOutputExtensionsInPackageBuildOutputFolder>

    <!-- Package Version.
      https://docs.microsoft.com/en-gb/dotnet/standard/library-guidance/versioning
    -->
    <!-- Discard warning NU5105 (SemVer 1.0) -->
    <NoWarn>$(NoWarn);NU5105</NoWarn>
    <VersionPrefix>$(MajorVersion).$(MinorVersion).$(PatchVersion)</VersionPrefix>
    <VersionSuffix>$(PreReleaseLabel.Replace('.', '-'))</VersionSuffix>

    <!-- Strong name the assembly.
      https://docs.microsoft.com/en-gb/dotnet/standard/library-guidance/strong-naming
      https://github.com/dotnet/runtime/blob/master/docs/project/strong-name-signing.md
    -->
    <SignAssembly>true</SignAssembly>
    <DefineConstants>$(DefineConstants);SIGNED_ASSEMBLY</DefineConstants>
    <AssemblyOriginatorKeyFile>$(MSBuildThisFileDirectory)Maybe.snk</AssemblyOriginatorKeyFile>
    <DelaySign>false</DelaySign>
  </PropertyGroup>

  <!-- This target must run very early (before Build is not enough) -->
  <Target Name="SetVersions" BeforeTargets="GetAssemblyAttributes">
    <Message Text="Creating the assembly version file..." Importance="normal" />

    <GenerateBuildAndRevisionNumbers>
      <Output TaskParameter="BuildNumber" PropertyName="_BuildNumber"/>
      <Output TaskParameter="RevisionNumber" PropertyName="_RevisionNumber"/>
    </GenerateBuildAndRevisionNumbers>

    <PropertyGroup>
      <_SemVer>$(MajorVersion).$(MinorVersion).$(PatchVersion)</_SemVer>
      <_SemVer Condition=" '$(PreReleaseLabel)' != '' ">$(_SemVer)-$(PreReleaseLabel)</_SemVer>

      <_BuildMetadata>$(Configuration).$(Platform)</_BuildMetadata>
      <_BuildMetadata Condition=" '$(Platform)|$(Prefer32Bit)' == 'AnyCPU|true' ">$(_BuildMetadata).32BitPref</_BuildMetadata>
      <!-- The assemlby is always signed here but we never know -->
      <_BuildMetadata Condition=" '$(SignAssembly)' == 'true' ">$(_BuildMetadata).Signed</_BuildMetadata>
      <_BuildMetadata Condition=" '$(SignAssembly)' != 'true' ">$(_BuildMetadata).Unsigned</_BuildMetadata>
      <_BuildMetadata>$(_BuildMetadata.ToLowerInvariant())</_BuildMetadata>

      <_SemVer>$(_SemVer)+$(_BuildMetadata)</_SemVer>
    </PropertyGroup>

    <PropertyGroup>
      <!-- To reduce binding redirects we only include the major & minor parts -->
      <AssemblyVersion>$(MajorVersion).$(MinorVersion).0.0</AssemblyVersion>
      <FileVersion>$(MajorVersion).$(MinorVersion).$(_BuildNumber).$(_RevisionNumber)</FileVersion>
      <InformationalVersion>$(_SemVer)</InformationalVersion>
    </PropertyGroup>
  </Target>

</Project>
<Project>

  <Import Project="$(MSBuildThisFileDirectory)Retail.tasks" />
  <Import Project="$(MSBuildThisFileDirectory)Retail.props" />

  <PropertyGroup>
    <!-- Deterministic build? Disabled as it seems to conflict with the fact
       that we change the assembly file version on every build.
       https://blog.paranoidcoding.com/2016/04/05/deterministic-builds-in-roslyn.html
      -->
    <!--<Deterministic>true</Deterministic>-->

    <!-- Include the symbols -->
    <AllowedOutputExtensionsInPackageBuildOutputFolder>$(AllowedOutputExtensionsInPackageBuildOutputFolder);.pdb</AllowedOutputExtensionsInPackageBuildOutputFolder>

    <!-- Semantic version -->
    <BuildMetadata Condition=" '$(RepositoryCommit)' != '' ">$(RepositoryCommit.Substring(0, 7))</BuildMetadata>
    <SemanticVersion>$(MajorVersion).$(MinorVersion).$(PatchVersion)</SemanticVersion>
    <SemanticVersion Condition=" '$(PreReleaseLabel)' != '' ">$(SemanticVersion)-$(PreReleaseLabel)</SemanticVersion>
    <SemanticVersion Condition=" '$(BuildMetadata)' != '' ">$(SemanticVersion)+$(BuildMetadata)</SemanticVersion>

    <!-- Package.
      Override the dummy version set within Directory.Build.props.
      https://docs.microsoft.com/en-gb/dotnet/standard/library-guidance/versioning
    -->
    <!-- Discard warning NU5105 (SemVer 1.0) -->
    <NoWarn>$(NoWarn);NU5105</NoWarn>
    <VersionPrefix>$(MajorVersion).$(MinorVersion).$(PatchVersion)</VersionPrefix>
    <VersionSuffix>$(PreReleaseLabel)</VersionSuffix>

    <!-- Assembly.
      To reduce binding redirects we only include the major & minor parts.
      Oddly the default behaviour is to use the assembly name (Abc.Maybe) for
      AssemblyTitle, not Title.
      -->
    <AssemblyVersion>$(MajorVersion).$(MinorVersion).0.0</AssemblyVersion>
    <AssemblyTitle>$(Title)</AssemblyTitle>
    <Description Condition=" '$(Description)' != '' ">$(Description) </Description>
    <Description>$(Description)[$(Configuration) build on $([System.DateTime]::UtcNow.ToString("r"))]</Description>
    <InformationalVersion>$(SemanticVersion)</InformationalVersion>

    <!-- Strong name the assembly.
      https://docs.microsoft.com/en-gb/dotnet/standard/library-guidance/strong-naming
      https://github.com/dotnet/runtime/blob/master/docs/project/strong-name-signing.md
    -->
    <SignAssembly>true</SignAssembly>
    <DefineConstants>$(DefineConstants);SIGNED_ASSEMBLY</DefineConstants>
    <AssemblyOriginatorKeyFile>$(MSBuildThisFileDirectory)Maybe.snk</AssemblyOriginatorKeyFile>
    <DelaySign>false</DelaySign>
  </PropertyGroup>

  <!-- This target must run very early (before Build is not enough) -->
  <Target Name="SetFileVersion" BeforeTargets="GetAssemblyAttributes">
    <Message Text="Setting assembly file version." Importance="normal" />

    <GenerateBuildAndRevisionNumbers>
      <Output TaskParameter="BuildNumber" PropertyName="_BuildNumber"/>
      <Output TaskParameter="RevisionNumber" PropertyName="_RevisionNumber"/>
    </GenerateBuildAndRevisionNumbers>

    <PropertyGroup>
      <FileVersion>$(MajorVersion).$(MinorVersion).$(_BuildNumber).$(_RevisionNumber)</FileVersion>
    </PropertyGroup>
  </Target>

</Project>